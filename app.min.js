/*!
 * ork-champions
 * Copyright (c) 2020-2026 Alex Howansky
 * Licensed under MIT (https://github.com/AlexHowansky/ork-champions/blob/master/LICENSE)
 */
$(function(){const config={checkedIcon:'fa-solid fa-check-square text-success',uncheckedIcon:'fa-solid fa-square text-dark',pcIcon:'fa-solid fa-user text-primary',npcIcon:'fa-solid fa-robot text-secondary',linkIcon:'fa-solid fa-eye text-primary',activeIcon:'fa-solid fa-check text-success',inactiveIcon:'fa-solid fa-xmark text-danger',accordionClosedIcon:'fa-solid fa-chevron-right',accordionOpenIcon:'fa-solid fa-chevron-down',flashedIcon:'<i class="fa-solid fa-eye-low-vision text-danger" title="Flashed {{flashed}}"></i>',knockedOutIcon:'<i class="fa-solid fa-face-dizzy text-danger" title="Knocked Out"></i>',recoveryIcon:'<i class="fa-solid fa-suitcase-medical text-danger pointer" title="Take A Recovery" data-recovery="{{characterId}}"></i>',statuses:[{name:'Dead',icon:'fa-solid fa-skull text-info'},{name:'Drained',icon:'fa-solid fa-faucet-drip text-info'},{name:'Entangled',icon:'fa-solid fa-handcuffs text-info'},{name:'Prone',icon:'fa-solid fa-person-falling text-info'},{name:'Sleeping',icon:'fa-solid fa-bed text-info'},{name:'Stunned',icon:'fa-solid fa-face-flushed text-info'},{name:'Suppressed',icon:'fa-solid fa-hands-holding-circle text-info'},],}
$('#campaignList').on('click','div.card>div.card-header',function(){champions.setCurrentCampaign($(this).data('id')).then(toggleAccordion('campaignList',$(this).data('id')))});$('#campaignList').on('click','div.card>div.collapse>ul>li>i.fa-solid[data-id]',function(){champions.toggleCharacterActive($(this).data('id')).then(active=>$(this).removeClass().addClass(getActiveIcon(active))).then(recover($(this).data('id'),!0)).then(renderCombatTable())});$('#importButton').click(function(){$('#importFile').click()});$('#importFile').change(function(){var file=$('#importFile').prop('files')[0];var reader=new FileReader();reader.readAsText(file);reader.onload=function(event){if(file.name.endsWith('.hdc')){var parser=new DOMParser();var xml=parser.parseFromString(event.target.result,'text/xml');var ed6=getXml(xml,'CHARACTER','TEMPLATE').includes('6');var body=10+getXml(xml,'BODY');var con=10+getXml(xml,'CON');var dex=10+getXml(xml,'DEX');var str=10+getXml(xml,'STR');var end=ed6?(20+getXml(xml,'END')):(2*con+getXml(xml,'END'));var speed=ed6?(2+getXml(xml,'SPD')):(Math.floor(1+(dex/10)+getXml(xml,'SPD')));var stun=ed6?(20+getXml(xml,'STUN')):(body+Math.round(str/2)+Math.round(con/2)+getXml(xml,'STUN'));var rec=ed6?(4+getXml(xml,'REC')):(Math.round(str/5)+Math.round(con/5)+getXml(xml,'REC'))
var reflexes=0;for(const talent of xml.getElementsByTagName('TALENT')){if(talent.getAttribute('XMLID')==='LIGHTNING_REFLEXES_ALL'){reflexes=Number(talent.getAttribute('LEVELS'));break}}
champions.putCharacter({body:body,campaign:getXml(xml,'CHARACTER_INFO','CAMPAIGN_NAME'),dex:dex,end:end,maxBody:body,maxEnd:end,maxRec:rec,maxStun:stun,name:getXml(xml,'CHARACTER_INFO','CHARACTER_NAME'),reflexes:reflexes,speed:speed,stun:stun,})}else{JSON.parse(event.target.result).forEach(character=>champions.putCharacter(character))}
refresh(!0)}});$('#exportButton').click(function(){champions.getCharacters().then(characters=>{characters.forEach(character=>delete character.id);let a=document.createElement('a');a.setAttribute('href','data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(characters)));a.setAttribute('download','championsCharacters_'+(new Date()).toLocaleDateString('en-US').split('/').join('-')+'.json');a.click()})});$('body').on('click','*[data-cid]',function(){champions.getCharacter($(this).data('cid')).then(character=>{$('#editCharacterCampaign').val(character.campaign);$('#editCharacterName').val(character.name);$('#editCharacterUrl').val(character.url);$('#editCharacterSpeed').val(character.speed);$('#editCharacterDex').val(character.dex);$('#editCharacterFlashed').val(character.flashed);$('#editCharacterReflexes').val(character.reflexes);$(character.pc?'#editCharacterPc':'#editCharacterNpc').prop('checked',!0);$('#editCharacterMaxEnd').val(character.maxEnd);$('#editCharacterMaxStun').val(character.maxStun);$('#editCharacterMaxBody').val(character.maxBody);$('#editCharacterMaxRec').val(character.maxRec);$('#editCharacterEnd').val(character.end);$('#editCharacterStun').val(character.stun);$('#editCharacterBody').val(character.body);if(character.pc){$('#editCharacterStats').hide()}else{$('#editCharacterStats').show()}
$('#editCharacterFormDeleteButton').data('id',character.id);$('#editCharacterModal').modal('show');let statusSelector=$('#editCharacterStatus').selectize()[0].selectize;statusSelector.clear();statusSelector.clearOptions();config.statuses.forEach(status=>statusSelector.addOption(status));character.status.filter(name=>isCustomStatus(name)).forEach(name=>statusSelector.addOption({name:name}));statusSelector.setValue(character.status)})});$('body').on('click','*[data-recovery]',function(){champions.getCharacter($(this).data('recovery')).then(character=>{if(!character.pc){character.end=Math.min(character.end+character.maxRec,character.maxEnd);character.stun=Math.min(character.stun+character.maxRec,character.maxStun);champions.updateCharacter($(this).data('recovery'),{end:character.end,stun:character.stun}).then(renderCombatTable())}})});$('#editCharacterRestButton').click(function(){recover($('#editCharacterFormDeleteButton').data('id'),!0)});$('#editCharacterRecoverButton').click(function(){recover($('#editCharacterFormDeleteButton').data('id'),!1)});$('#clearButton').click(function(){champions.deactivateAllCharacters(function(character){$('#campaignList>div.card>div.collapse>ul>li>i.fa-solid[data-id="'+character.id+'"]').removeClass().addClass(getActiveIcon(0));$('#combatTable>tr[data-id="'+character.id+'"]').remove()}).then(enableBattleTableControls(!1))});$('#resetButton').click(function(){champions.reset().then(champions.getActiveCharacters().then(characters=>{characters.forEach(character=>{recover(character.id,!0)})})).then(findNext())});$('#nextButton').click(function(){findNext()});$('#modeButton').click(function(){$('html').attr('data-bs-theme',$('html').attr('data-bs-theme')=='dark'?'light':'dark')});$('#combatTable').on('click','tr>td[data-segment]',function(){champions.setCurrentCharacter($(this).data('character')).then(champions.setCurrentSegment($(this).data('segment')).then(renderCombatTableHighlight($(this).data('character'),$(this).data('segment'))))});$('#editCharacterFormCancelButton').click(function(event){$('#editCharacterModal').modal('hide');$('#editCharacterForm').trigger('reset')});$('#editCharacterFormDeleteButton').click(function(event){const characterId=$('#editCharacterFormDeleteButton').data('id');champions.deleteCharacter(characterId).then(()=>{$('#editCharacterModal').modal('hide');$('#editCharacterForm').trigger('reset');refresh()})});$('#editCharacterFormDuplicateButton').click(function(event){champions.getCharacter($('#editCharacterFormDeleteButton').data('id')).then(character=>{champions.getDuplicateName(character.name).then(duplicateName=>{duplicateCharacter=Object.assign({},character);duplicateCharacter.name=duplicateName;delete duplicateCharacter.id;champions.putCharacter(duplicateCharacter)}).then(()=>{$('#editCharacterModal').modal('hide');$('#editCharacterForm').trigger('reset');refresh()})})});$('#editCharacterForm').submit(function(event){event.preventDefault();champions.updateCharacter($('#editCharacterFormDeleteButton').data('id'),{campaign:$('#editCharacterCampaign').val(),name:$('#editCharacterName').val(),url:$('#editCharacterUrl').val(),speed:parseInt($('#editCharacterSpeed').val())||0,dex:parseInt($('#editCharacterDex').val())||0,flashed:parseInt($('#editCharacterFlashed').val())||0,reflexes:parseInt($('#editCharacterReflexes').val())||0,pc:$('#editCharacterPc:checked').val()?1:0,maxEnd:parseInt($('#editCharacterMaxEnd').val())||0,maxStun:parseInt($('#editCharacterMaxStun').val())||0,maxBody:parseInt($('#editCharacterMaxBody').val())||0,maxRec:parseInt($('#editCharacterMaxRec').val())||0,end:parseInt($('#editCharacterEnd').val())||0,status:$('#editCharacterStatus').val(),stun:parseInt($('#editCharacterStun').val())||0,body:parseInt($('#editCharacterBody').val())||0}).then(()=>{$('#editCharacterModal').modal('hide');$('#editCharacterForm').trigger('reset');refresh(!0)}).catch('Error',e=>{alert('ERROR: New name already exists.')})});$('#editCharacterPc').click(function(event){$('#editCharacterStats').hide()});$('#editCharacterNpc').click(function(event){$('#editCharacterStats').show()});$('#newCharacterFormCancelButton').click(function(event){$('#newCharacterModal').modal('hide');$('#newCharacterForm').trigger('reset')});$('#newCharacterForm').submit(function(event){event.preventDefault();champions.putCharacter({campaign:$('#newCharacterCampaign').val(),name:$('#newCharacterName').val(),url:$('#newCharacterUrl').val(),speed:parseInt($('#newCharacterSpeed').val())||0,dex:parseInt($('#newCharacterDex').val())||0,reflexes:parseInt($('#newCharacterReflexes').val())||0,pc:$('#newCharacterPc:checked').val()?1:0}).then(()=>{$('#newCharacterModal').modal('hide');$('#newCharacterForm').trigger('reset');refresh(!0)}).catch('ConstraintError',e=>{alert('ERROR: Name already exists.')})});$('#post12OkButton').click(function(event){renderCombatTable()});$("#editCharacterStatus").selectize({create:!0,createOnBlur:!0,persist:!1,plugins:['remove_button'],render:{item:function(status,escape){return'<div class="item">'+(status.icon?('<i class="ps-0 pe-1 '+escape(status.icon)+'"></i>'):'')+escape(status.name)+'</div>'},option:function(status,escape){return'<div>'+(status.icon?('<i class="ps-1 pe-1 '+escape(status.icon)+'"></i>'):'')+escape(status.name)+'</div>'}},valueField:'name',});function enableBattleTableControls(enable=!0){$('.battleTableControls>button').prop('disabled',!enable)}
async function findNext(){let currentCharacter=await champions.getCurrentCharacter();let currentSegment=await champions.getCurrentSegment();let characters=await champions.getActiveCharacters();if(currentSegment===null||currentCharacter===null){currentSegment=12;currentCharacter=-1}
let segments=0;do{if(++currentCharacter>=characters.length){currentCharacter=0;++segments;if(++currentSegment>12){await post12();currentSegment=1}}}while(speedActsInSegment(characters[currentCharacter].speed,currentSegment)===!1);await champions.setCurrentCharacter(currentCharacter);await champions.setCurrentSegment(currentSegment);await flashDecrement(segments);renderCombatTable()}
function flashDecrement(segments){return champions.getActiveCharacters().then(characters=>{characters.forEach(character=>{if(!character.pc&&character.flashed>0){champions.updateCharacter(character.id,{flashed:Math.max(character.flashed-segments,0)})}})})}
function getActiveIcon(active){return active?config.checkedIcon:config.uncheckedIcon}
function getIconForStatus(name){let status=config.statuses.find(status=>status.name==name);return status?template('combatTableStatusIconTemplate',{icon:status.icon,title:status.name}):template('combatTableCustomStatusIconTemplate',{name:name})}
function getSegmentsForSpeed(speed){return{1:[7],2:[6,12],3:[4,8,12],4:[3,6,9,12],5:[3,5,8,10,12],6:[2,4,6,8,10,12],7:[2,4,6,7,9,11,12],8:[2,3,5,6,8,9,11,12],9:[2,3,4,6,7,8,10,11,12],10:[2,3,4,5,6,8,9,10,11,12],11:[2,3,4,5,6,7,8,9,10,11,12],12:[1,2,3,4,5,6,7,8,9,10,11,12],}[speed]}
function getXml(xml,tag,attr='LEVELS'){var value=xml.getElementsByTagName(tag)[0].getAttribute(attr);return isNaN(value)?value:Number(value)}
function isCustomStatus(name){return!config.statuses.map(status=>status.name).includes(name)}
function post12(){return champions.getActiveCharacters().then(characters=>{characters.forEach(character=>{if(!character.pc&&character.stun>0){recover(character.id)}})}).then($('#post12').modal('show'))}
function recover(cid,rest=!1){champions.getCharacter(cid).then(character=>{if(rest){character.end=character.maxEnd;character.stun=character.maxStun;character.body=character.maxBody}else{character.end=Math.min(character.end+character.maxRec,character.maxEnd);character.stun=Math.min(character.stun+character.maxRec,character.maxStun)}
champions.updateCharacter(cid,{end:character.end,stun:character.stun,body:character.body});$('#editCharacterEnd').val(character.end);$('#editCharacterStun').val(character.stun);$('#editCharacterBody').val(character.body)})}
function refresh(migrate=!1){if(migrate===!0){champions.migrate()}
renderCampaignList();renderCombatTable()}
function renderCampaignList(){return champions.getCharacters().then(characters=>{var html='';var campaignId=0;var campaignName;for(var i=0;i<characters.length;i++){if(campaignName!==characters[i].campaign){campaignName=characters[i].campaign;if(campaignId){html+=template('campaignListFooterTemplate')}
html+=template('campaignListHeaderTemplate',{campaignId:++campaignId,campaignName:campaignName,accordionIcon:config.accordionClosedIcon})}
html+=template('campaignListCharacterTemplate',{characterId:characters[i].id,name:characters[i].name,url:characters[i].url,checkIcon:characters[i].active?config.checkedIcon:config.uncheckedIcon,pcIcon:characters[i].pc?config.pcIcon:config.npcIcon,pcTitle:characters[i].pc?'PC':'NPC',linkIcon:characters[i].url?config.linkIcon:''})}
if(html){html+=template('campaignListFooterTemplate');$('#campaignList').html(html)}}).then(()=>champions.getCurrentCampaign()).then(campaign=>toggleAccordion('campaignList',campaign))}
function renderCombatTable(){$('#combatTable>tr').remove();return champions.getActiveCharacters().then(characters=>{characters.forEach((character,index)=>{var row=template('combatTableRowHeaderTemplate',{characterId:character.id,name:character.name,url:character.url?character.url:'#',speed:character.speed,end:xOfY(character,'end','maxEnd'),stun:xOfY(character,'stun','maxStun'),body:xOfY(character,'body','maxBody'),dex:character.dex,initiative:character.dex+character.reflexes,pcIcon:character.pc?config.pcIcon:config.npcIcon,pcTitle:character.pc?'PC':'NPC',flashed:character.pc?'':character.flashed,flashedIcon:character.pc?'':(character.flashed>0?config.flashedIcon:''),knockedOutIcon:character.pc?'':(character.stun>0?'':config.knockedOutIcon),recoveryIcon:character.pc?'':(character.end<character.maxEnd?config.recoveryIcon:''),statusIcons:character.status.map(name=>getIconForStatus(name)).join(' '),linkIcon:character.url?config.linkIcon:''});for(var segment=1;segment<=12;segment++){if(speedActsInSegment(character.speed,segment)){row+=template('combatTableCellActiveTemplate',{characterIndex:index,segment:segment,icon:config.activeIcon})}else{row+=template('combatTableCellInactiveTemplate',{icon:config.inactiveIcon})}}
row+=template('combatTableRowFooterTemplate');$('#combatTable').append(row)});enableBattleTableControls(characters.length>0)}).then(()=>{champions.getCurrentCharacter().then(currentCharacter=>{champions.getCurrentSegment().then(currentSegment=>{renderCombatTableHighlight(currentCharacter,currentSegment)})})})}
function renderCombatTableHighlight(currentCharacter,currentSegment){$('#combatTable>tr>td').removeClass('bg-warning');if(currentSegment>0){$($('#combatTable>tr:nth-child('+(currentCharacter+1)+')').find('td')[currentSegment+6]).addClass('bg-warning')}}
function speedActsInSegment(speed,segment){return getSegmentsForSpeed(speed).includes(segment)}
function template(id,vars={}){var text=$('#'+id).html();Object.entries(vars).forEach(([key,value])=>text=text.replace(new RegExp(`{{${key}}}`,'g'),`${value}`));Object.entries(vars).forEach(([key,value])=>text=text.replace(new RegExp(`{{${key}}}`,'g'),`${value}`));return text}
function toggleAccordion(accordionId,cardHeaderId){$('#'+accordionId+'>div.card>div.card-header[data-id]').each(function(){var icon=$(this).find('i.fa-solid');var collapse=$(this).parent().find('div.collapse');if($(this).data('id')===cardHeaderId&&!collapse.hasClass('show')){collapse.collapse('show');icon.removeClass().addClass(config.accordionOpenIcon)}else{collapse.collapse('hide');icon.removeClass().addClass(config.accordionClosedIcon)}})}
function xOfY(character,x,y){if(character.pc){return''}
if(character[x]===character[y]){return character[x]}
return'<span class="text-info">'+character[x]+'</span> ('+character[y]+')'}
document.querySelector('html').setAttribute('data-bs-theme',window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light');refresh(!0)})